COMPONENTS
  1-Header
    -Header: Sabit Header
    -ProfileMenu: Profil sayfasÄ± olacak (yapÄ±lmadÄ±)

  2-Process
    -ProcessAdd: Process ekleme ekranÄ± -path: /add-process

  3-Project
    -ProjectCartSelectModal: Proje kartÄ±na tÄ±klandÄ±ÄŸÄ±nda aÃ§Ä±lan Modal
    -ProjectTasks: Projeye ait tÃ¼m gÃ¶revlerin gÃ¶sterildiÄŸi Ekran (ProjectCartSelectModal'da "GÃ¶revleri GÃ¶rÃ¼ntÃ¼le" butonuna tÄ±klandÄ±ÄŸÄ±nda aÃ§Ä±lÄ±r) -path: /projectTasks
    -ProjectProcessSelectModal: Projeye eklenecek sÃ¼reÃ§lerin seÃ§ildiÄŸi ekran (ProjectCartSelectModal'da "SÃ¼reÃ§ OluÅŸtur" butonuna tÄ±klandÄ±ÄŸÄ±nda aÃ§Ä±lÄ±r)

  4-Tasks
    -TaskAdd: Task Ekleme EkranÄ± -path: /add-task

LAYOUT
  -AdminDashboard: Ana ekran div'i gibi dÃ¼ÅŸÃ¼nebiliriz. Route sayfasÄ±nda sidebar iÃ§erecek tÃ¼m sayfalar bu sayfanÄ±n altÄ±na eklenir.

PAGES
  -Login: GiriÅŸ SayfasÄ±
  -MyTasks: GÃ¶revlerim sayfasÄ±
  -Processes: SÃ¼reÃ§ler SayfasÄ±
  -ProjectCreated: Proje Ekleme SayfasÄ±
  -Projects: Projelerin gÃ¶rÃ¼ntÃ¼lendiÄŸi sayfa




  import { useEffect, useState, useCallback, useMemo } from "react";
import axios from "axios";
import { 
  Select, Textarea, Card, Text, Group, Stack, Badge, Button, 
  Progress, Pagination, Grid, Paper, Title, Divider 
} from "@mantine/core";
import { IconCalendar, IconArrowLeft, IconUsers, IconClock } from '@tabler/icons-react';
import Header from "../Header/Header";
import FilterAndSearch from "../../Layout/FilterAndSearch";

const ProjectTasks = () => {
  const [projectName, setProjectName] = useState("");
  const [projectProcesses, setProjectProcesses] = useState([]);
  const [loading, setLoading] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [selectedProcess, setSelectedProcess] = useState(null);
  const [taskToReassign, setTaskToReassign] = useState(null);
  const [users, setUsers] = useState([]);
  const [selectedUserId, setSelectedUserId] = useState(null);
  const [searchFilters, setSearchFilters] = useState({
    processName: "",
    taskName: "",
    status: "",
    startDate: "",
    endDate: ""
  });

  const ITEMS_PER_PAGE = 6;
  const CARD_HEIGHT = 400;
  
  // Cache edilmiÅŸ veriler
  const user = useMemo(() => JSON.parse(localStorage.getItem("user") || "{}"), []);
  const currentUserId = user?.id || 1;
  const projectId = localStorage.getItem("selectedProjectId");
  const token = localStorage.getItem("token");

  // Status helper functions - memoized
  const statusConfig = useMemo(() => ({
    NotStarted: { label: "BaÅŸlamadÄ±", color: "#7ed2e2" },
    InProgress: { label: "Devam Ediyor", color: "#ffd43b" },
    Completed: { label: "TamamlandÄ±", color: "#51cf66" },
    Cancelled: { label: "Ä°ptal Edildi", color: "#ff6b6b" }
  }), []);

  const getStatusLabel = useCallback((status) => statusConfig[status]?.label || status, [statusConfig]);
  const getStatusColor = useCallback((status) => statusConfig[status]?.color || "#7ed2e2", [statusConfig]);

  // KullanÄ±cÄ± ismini id'den almak iÃ§in yardÄ±mcÄ± fonksiyon
  const getUserNameById = useCallback((id) => {
    const u = users.find(u => u.id === id);
    return u ? u.name : "AtanmamÄ±ÅŸ";
  }, [users]);

  // KullanÄ±cÄ±larÄ± API'den Ã§ek
  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const res = await axios.get("http://localhost:5000/api/users", {
          headers: { Authorization: `Bearer ${token}` }
        });
        setUsers(res.data);
      } catch (error) {
        console.error("KullanÄ±cÄ±lar alÄ±namadÄ±", error);
      }
    };

    fetchUsers();
  }, [token]);

  // Orijinal API Ã§aÄŸrÄ± mantÄ±ÄŸÄ±nÄ± koruyarak optimize et
  const fetchProjectData = useCallback(async () => {
    if (!projectId) return;
    
    setLoading(true);
    try {
      // 1. Proje adÄ±
      const projectRes = await axios.get(
        `http://localhost:5000/api/projects/${projectId}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );
      setProjectName(projectRes.data.name);

      // 2. ProjectTasks verisi
      const projectTasksRes = await axios.get(
        `http://localhost:5000/api/projectTasks/by-project/${projectId}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );

      // GruplandÄ±r
      const grouped = {};
      for (const task of projectTasksRes.data) {
        const processId = task.processId;
        if (!grouped[processId]) grouped[processId] = [];
        grouped[processId].push(task);
      }

      // Her process iÃ§in detaylarÄ± getir
      const result = await Promise.all(
        Object.entries(grouped).map(async ([processId, tasks]) => {
          let processName = "";
          let assignedUser = "";
          let processCreatedDate = "";

          // Process bilgisi
          try {
            const processRes = await axios.get(
              `http://localhost:5000/api/processes/${processId}`,
              { headers: { Authorization: `Bearer ${token}` } }
            );
            processName = processRes.data.name;
            processCreatedDate = processRes.data.createdAt;
          } catch (err) {
            console.error(`Process ${processId} alÄ±namadÄ±:`, err);
          }

          // User bilgisi (ilk atanan)
          try {
            const firstAssigned = tasks.find(t => t.assignedUserId);
            if (firstAssigned) {
              const userRes = await axios.get(
                `http://localhost:5000/api/users/${firstAssigned.assignedUserId}`,
                { headers: { Authorization: `Bearer ${token}` } }
              );
              assignedUser = userRes.data.name;
            }
          } catch (err) {
            console.error("User bilgisi alÄ±namadÄ±:", err);
          }

          // Task detaylarÄ±
          const tasksWithNames = await Promise.all(
            tasks.map(async (task) => {
              try {
                const taskRes = await axios.get(
                  `http://localhost:5000/api/tasks/${task.taskId}`,
                  { headers: { Authorization: `Bearer ${token}` } }
                );
                return { ...task, task: taskRes.data };
              } catch (err) {
                console.error(`Task ${task.taskId} alÄ±namadÄ±:`, err);
                return { ...task, task: { title: "Bilinmeyen GÃ¶rev" } };
              }
            })
          );

          // SÄ±rala
          const sortedTasks = tasksWithNames.sort((a, b) =>
            (a.task.order || 0) - (b.task.order || 0)
          );

          return {
            processId,
            processName,
            assignedUser,
            processCreatedDate,
            tasks: sortedTasks,
          };
        })
      );

      setProjectProcesses(result);
    } catch (err) {
      console.error("Veriler alÄ±namadÄ±", err);
    } finally {
      setLoading(false);
    }
  }, [projectId, token]);

  // FiltrelenmiÅŸ sÃ¼reÃ§ler - memoized
  const filteredProcesses = useMemo(() => {
    let filtered = projectProcesses;

    if (searchFilters.processName) {
      filtered = filtered.filter(process =>
        process.processName.toLowerCase().includes(searchFilters.processName.toLowerCase())
      );
    }

    if (searchFilters.taskName || searchFilters.status || searchFilters.startDate || searchFilters.endDate) {
      filtered = filtered.map(process => ({
        ...process,
        tasks: process.tasks.filter(task => {
          const matchesTaskName = !searchFilters.taskName ||
            task.task?.title.toLowerCase().includes(searchFilters.taskName.toLowerCase());
          const matchesStatus = !searchFilters.status || task.status === searchFilters.status;
          const matchesStartDate = !searchFilters.startDate ||
            (task.startDate && task.startDate.split('T')[0] >= searchFilters.startDate);
          const matchesEndDate = !searchFilters.endDate ||
            (task.endDate && task.endDate.split('T')[0] <= searchFilters.endDate);

          return matchesTaskName && matchesStatus && matchesStartDate && matchesEndDate;
        })
      })).filter(process => process.tasks.length > 0);
    }

    return filtered;
  }, [projectProcesses, searchFilters]);

  // Ä°statistikler - memoized
  const calculateStatusStats = useCallback((tasks) => {
    if (!tasks.length) return { notStarted: 100, inProgress: 0, completed: 0, cancelled: 0 };

    const total = tasks.length;
    const stats = Object.keys(statusConfig).reduce((acc, status) => {
      acc[status.toLowerCase()] = tasks.filter(t => t.status === status).length;
      return acc;
    }, {});

    return Object.fromEntries(
      Object.entries(stats).map(([key, count]) => [key, Math.round((count / total) * 100)])
    );
  }, [statusConfig]);

  const projectStats = useMemo(() => {
    const allTasks = filteredProcesses.flatMap(p => p.tasks);
    return calculateStatusStats(allTasks);
  }, [filteredProcesses, calculateStatusStats]);

  // Event handlers
  const handleFilterChange = useCallback((key, value) => {
    setSearchFilters(prev => ({ ...prev, [key]: value }));
    setCurrentPage(1);
  }, []);

  const clearFilters = useCallback(() => {
    setSearchFilters({
      processName: "", taskName: "", status: "", startDate: "", endDate: ""
    });
  }, []);

  const handleComplete = useCallback(async (task) => {
    try {
      const dto = {
        status: task.status,
        startDate: task.startDate,
        assignedUserId: task.assignedUserId,
        endDate: task.endDate || null,
        description: task.description,
        filePath: task.filePath || null,
        updatedByUserId: currentUserId,
      };

      await axios.put(`http://localhost:5000/api/projectTasks/${task.id}`, dto, {
        headers: { Authorization: `Bearer ${token}` },
      });

      alert("GÃ¶rev baÅŸarÄ±yla gÃ¼ncellendi");
    } catch (err) {
      console.error("GÃ¼ncelleme hatasÄ±:", err.response?.data || err.message);
    }
  }, [currentUserId, token]);

  // Atama deÄŸiÅŸikliÄŸi iÃ§in
  const handleReassign = async () => {
    if (!selectedUserId || !taskToReassign) {
      alert("LÃ¼tfen bir kullanÄ±cÄ± seÃ§in.");
      return;
    }
    try {
      await axios.put(
        `http://localhost:5000/api/projectTasks/${taskToReassign.id}`,
        { assignedUserId: selectedUserId, updatedByUserId: currentUserId },
        { headers: { Authorization: `Bearer ${token}` } }
      );

      setProjectProcesses(prev =>
        prev.map(p => ({
          ...p,
          tasks: p.tasks.map(t =>
            t.id === taskToReassign.id ? { ...t, assignedUserId: selectedUserId } : t
          )
        }))
      );

      setTaskToReassign(null);
      setSelectedUserId(null);
      alert("Atama baÅŸarÄ±yla deÄŸiÅŸtirildi.");
    } catch (error) {
      console.error("Atama deÄŸiÅŸtirilemedi", error);
      alert("Atama deÄŸiÅŸtirilemedi.");
    }
  };

  const updateTaskInState = useCallback((taskId, updates) => {
    setProjectProcesses(prev =>
      prev.map(p => ({
        ...p,
        tasks: p.tasks.map(t => t.id === taskId ? { ...t, ...updates } : t)
      }))
    );
  }, []);

  const formatDate = useCallback((dateString) => {
    return dateString ? new Date(dateString).toLocaleDateString('tr-TR') : "BelirtilmemiÅŸ";
  }, []);

  // Effects
  useEffect(() => {
    fetchProjectData();
  }, [fetchProjectData]);

  // StatusBar component
  const StatusBar = ({ stats, size = "md", showLabels = true }) => (
    <div style={{ width: '100%' }}>
      {showLabels && (
        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
          {Object.entries(statusConfig).map(([key, config]) => {
            const statKey = key.toLowerCase();
            return (
              <Text key={key} size="xs" style={{ color: config.color }}>
                {config.label}: {stats[statKey] || 0}%
              </Text>
            );
          })}
        </div>
      )}
      <div style={{ display: 'flex', gap: 4 }}>
        {Object.entries(statusConfig).map(([key, config]) => {
          const statKey = key.toLowerCase();
          return (
            <div key={key} style={{ flex: 1 }}>
              <Progress value={stats[statKey] || 0} color={config.color} size={size} />
            </div>
          );
        })}
      </div>
    </div>
  );

  if (loading) {
    return (
      <div className="p-8 text-center min-h-[400px] flex items-center justify-center bg-[#effafc]">
        <Stack align="center" spacing="md">
          <div className="w-10 h-10 rounded-full animate-spin border-3 border-[#d6f3f7] border-t-[#279ab3]" />
          <Text size="lg" color="dimmed">YÃ¼kleniyor...</Text>
        </Stack>
      </div>
    );
  }

  // Process Cards View
  if (!selectedProcess) {
    return (
      <div className="min-h-screen bg-white">
        <Header
          title="SÃ¼reÃ§ler"
          subtitle={`${projectName} Projesine Ait SÃ¼reÃ§ler`}
          icon={IconCalendar}
          stats={projectStats}
          showStats={true}
        />

        <div className="px-4">
          <FilterAndSearch
            searchFilters={searchFilters}
            handleFilterChange={handleFilterChange}
            clearFilters={clearFilters}
            filtersConfig={[
              {key:"processName", type:"text", placeholder: "SÃ¼reÃ§ adÄ±na gÃ¶re ara..."},
              {key:"startDate", type:"date"},
              {key:"endDate", type:"date"}
            ]}
          />

          <Grid gutter="lg">
            {filteredProcesses.map((process) => {
              const processStats = calculateStatusStats(process.tasks);
              return (
                <Grid.Col key={process.processId} span={{ base: 12, sm: 6, lg: 4 }}>
                  <Card
                    withBorder
                    padding="lg"
                    className="cursor-pointer transition-all duration-200 hover:shadow-lg"
                    style={{ height: 280 }}
                    onClick={() => setSelectedProcess(process)}
                  >
                    <Stack spacing="md" style={{ height: '100%' }}>
                      <div>
                        <Title order={4} className="text-[#112d3b] mb-2">
                          {process.processName}
                        </Title>
                        <Text size="sm" color="#7ed2e2">
                          ðŸ“… OluÅŸturulma: {formatDate(process.processCreatedDate)}
                        </Text>
                      </div>

                      <Divider />

                      <Stack spacing="xs">
                        <Group spacing="xs">
                          <IconUsers size={16} color="#279ab3" />
                          <Text size="sm" color="#279ab3">
                            Atanan: {process.assignedUser}
                          </Text>
                        </Group>
                        
                        <Group spacing="xs">
                          <Text size="sm" color="#279ab3">
                            Toplam GÃ¶rev: {process.tasks.length}
                          </Text>
                        </Group>

                        <Group spacing="xs">
                          <IconClock size={16} color="#51cf66" />
                          <Text size="sm" color="#51cf66">
                            Tamamlanan: {process.tasks.filter(t => t.status === 'Completed').length}
                          </Text>
                        </Group>
                      </Stack>

                      <div className="mt-auto">
                        <Text size="sm" weight={500} color="#279ab3" className="mb-2">
                          Ä°lerleme Durumu
                        </Text>
                        <StatusBar stats={processStats} size="sm" showLabels={false} />
                      </div>
                    </Stack>
                  </Card>
                </Grid.Col>
              );
            })}
          </Grid>

          {filteredProcesses.length === 0 && (
            <Paper shadow="md" padding="xl" className="text-center mt-8">
              <Text size="lg" color="#279ab3" weight={500}>
                Arama kriterlerinize uygun sÃ¼reÃ§ bulunamadÄ±.
              </Text>
              <Button variant="light" color="#279ab3" onClick={clearFilters} className="mt-4">
                Filtreleri Temizle
              </Button>
            </Paper>
          )}
        </div>
      </div>
    );
  }

  // Task Details View
  const currentProcess = filteredProcesses.find(p => p.processId === selectedProcess.processId);
  if (!currentProcess) return null;

  const processStats = calculateStatusStats(currentProcess.tasks);
  const totalPages = Math.ceil(currentProcess.tasks.length / ITEMS_PER_PAGE);
  const paginatedTasks = currentProcess.tasks.slice(
    (currentPage - 1) * ITEMS_PER_PAGE, 
    currentPage * ITEMS_PER_PAGE
  );

  return (
    <div className="min-h-screen bg-white">
      <Header
        title={currentProcess.processName}
        subtitle={`${projectName} GÃ¶revleri`}
        stats={processStats}
        showStats={true}
      />

      <div className="px-4">
        <FilterAndSearch
          searchFilters={searchFilters}
          handleFilterChange={handleFilterChange}
          clearFilters={clearFilters}
          filtersConfig={[
            {key: "taskName", type: "text", placeholder:"GÃ¶rev adÄ±na gÃ¶re ara..."},
            {key: "startDate", type: "date"},
            {key: "endDate", type: "date"},
          ]}
        />
        
        <div className="flex justify-start mb-5">
          <Button
            onClick={() => setSelectedProcess(null)}
            className="bg-gradient-to-r from-[#279ab3] to-[#1d7a8c] text-white hover:from-[#1d7a8c] hover:to-[#155b6b]"
            leftIcon={<IconArrowLeft size={20} />}
          >
            SÃ¼reÃ§ler
          </Button>
        </div>

        <Grid gutter="lg">
          {paginatedTasks.map((task) => (
            <Grid.Col key={task.id} span={{ base: 12, sm: 6, lg: 4 }}>
              <Card
                withBorder
                padding="md"
                style={{ height: CARD_HEIGHT, borderColor: '#b3e6ee' }}
              >
                <Stack spacing="sm" style={{ height: '100%' }}>
                  <Group position="apart" align="flex-start">
                    <Text size="sm" weight={500} className="flex-1" style={{ color: '#112d3b' }}>
                      {task.task?.title || "Bilinmeyen GÃ¶rev"}
                    </Text>

                    <Badge color="cyan" size="sm" variant="light" radius="sm">
                      {getStatusLabel(task.status)}
                    </Badge>
                  </Group>

                  <Divider />

                  <Textarea
                    readOnly
                    minRows={3}
                    maxRows={3}
                    placeholder="GÃ¶rev aÃ§Ä±klamasÄ± yok."
                    value={task.description || ""}
                    autosize
                  />

                  <Text size="xs" color="dimmed" mt={4}>
                    BaÅŸlama Tarihi: {formatDate(task.startDate)}
                  </Text>

                  <Text size="xs" color="dimmed">
                    BitiÅŸ Tarihi:
                    <input
                      type="date"
                      className="border border-gray-300 rounded px-2 py-1 ml-2"
                      value={task.endDate ? task.endDate.split("T")[0] : ""}
                      onChange={(e) => {
                        updateTaskInState(task.id, { endDate: e.target.value });
                      }}
                    />
                  </Text>

                  {/* Atanan kullanÄ±cÄ± ve atama deÄŸiÅŸtirme */}
                  <Paper padding="xs" style={{ backgroundColor: '#effafc' }}>
                    <Text size="xs" color="#279ab3" weight={500}>
                      ðŸ‘¤ {getUserNameById(task.assignedUserId)}
                    </Text>

                    <Button
                      size="xs"
                      variant="outline"
                      color="blue"
                      mt={6}
                      onClick={() => {
                        setTaskToReassign(task);
                        setSelectedUserId(task.assignedUserId || null);
                      }}
                    >
                      AtamayÄ± DeÄŸiÅŸtir
                    </Button>

                    {taskToReassign?.id === task.id && (
                      <>
                        <Select
                          size="xs"
                          mt="xs"
                          data={users.map(user => ({ value: user.id.toString(), label: user.name }))}
                          value={selectedUserId?.toString() || ""}
                          onChange={(value) => setSelectedUserId(parseInt(value))}
                          placeholder="KullanÄ±cÄ± seÃ§in"
                          searchable
                          clearable
                        />
                        <Button
                          size="xs"
                          mt="xs"
                          onClick={handleReassign}
                        >
                          Kaydet
                        </Button>
                      </>
                    )}
                  </Paper>

                  <Textarea
                    placeholder="GÃ¶rev gÃ¼ncelleme aÃ§Ä±klamasÄ±"
                    minRows={3}
                    value={task.description || ""}
                    onChange={(e) => updateTaskInState(task.id, { description: e.target.value })}
                  />

                  <Group position="apart" mt="auto">
                    <Button
                      color="green"
                      size="sm"
                      onClick={() => {
                        updateTaskInState(task.id, { status: 'Completed' });
                        handleComplete({ ...task, status: 'Completed' });
                      }}
                      disabled={task.status === 'Completed'}
                    >
                      GÃ¶revi Tamamla
                    </Button>

                    {/* Dosya yÃ¼kleme alanÄ± */}
                    <input
                      type="file"
                      onChange={async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const formData = new FormData();
                        formData.append("file", file);

                        try {
                          const uploadRes = await axios.post(
                            "http://localhost:5000/api/upload",
                            formData,
                            {
                              headers: {
                                "Content-Type": "multipart/form-data",
                                Authorization: `Bearer ${token}`
                              }
                            }
                          );

                          updateTaskInState(task.id, { filePath: uploadRes.data.filePath });
                          alert("Dosya yÃ¼klendi.");
                        } catch (error) {
                          console.error("Dosya yÃ¼kleme hatasÄ±:", error);
                          alert("Dosya yÃ¼kleme baÅŸarÄ±sÄ±z.");
                        }
                      }}
                    />
                  </Group>
                </Stack>
              </Card>
            </Grid.Col>
          ))}
        </Grid>

        {totalPages > 1 && (
          <Pagination
            page={currentPage}
            onChange={setCurrentPage}
            total={totalPages}
            className="my-8"
          />
        )}
      </div>
    </div>
  );
};

export default ProjectTasks;
